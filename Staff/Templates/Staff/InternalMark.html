<!DOCTYPE html>
<html>
<head>
    <title>Internal Mark</title>
</head>
<body>

<form method="POST">
{% csrf_token %}

<input type="hidden" id="txt_id" value="{{uid}}">

<table border="1">
    <tr>
        <td>Semester</td>
        <td>
            <select id="sel_semester" name="sel_semester" required>
                <option value="">Select Semester</option>
                {% for i in semester %}
                <option value="{{i.id}}">{{i.semester_name}}</option>
                {% endfor %}
            </select>
        </td>
    </tr>

    <tr>
        <td>Subject</td>
        <td>
            <select id="sel_subject" name="sel_subject" required>
                <option value="">Select Subject</option>
            </select>
        </td>
    </tr>

    <tr>
        <td>First Internal</td>
        <td><input type="text" id="txt_first_exam_mark" readonly></td>
    </tr>

    <tr>
        <td>Second Internal</td>
        <td><input type="text" id="txt_second_exam_mark" readonly></td>
    </tr>

    <tr>
        <td>Assignment Mark</td>
        <td><input type="text" id="txt_assignment_mark" readonly></td>
    </tr>

    <tr>
        <td>Attendance Percentage</td>
        <td><input type="text" id="txt_percentage" readonly></td>
    </tr>

    <tr>
        <td>Internal Mark</td>
        <td><input type="text" name="txt_mark" required></td>
    </tr>

    <tr>
        <td colspan="2" align="center">
            <input type="submit" value="Submit">
        </td>
    </tr>
</table>

<br>

<table border="1">
    <tr>
        <td>SINO</td>
        <td>Semester</td>
        <td>Subject</td>
        <td>Date</td>
        <td>Mark</td>
        <td>Action</td>
    </tr>

    {% for i in internalmark %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ i.subject.semester.semester_name }}</td>
        <td>{{ i.subject.subject_name }}</td>
        <td>{{ i.internalmark_date }}</td>
        <td>{{ i.internalmark_mark }}</td>
        <td><a href="{% url 'Staff:delinternalmark' i.id %}">Delete</a></td>
    </tr>
    {% endfor %}
</table>

</form>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
/* Load Subjects + Attendance */
$("#sel_semester").change(function () {

    let semid = $(this).val();
    let uid = $("#txt_id").val();

    if (!semid) {
        $("#sel_subject").html('<option value="">Select Subject</option>');
        return;
    }

    // Load subjects
    $.ajax({
        url: "{% url 'Staff:AjaxSubjects' %}",
        data: { semid: semid },
        success: function (data) {
            $("#sel_subject").html(data);
        }
    });

    // Load attendance percentage
    $.ajax({
        url: "{% url 'Staff:AjaxAttendancePercentage' %}",
        data: { uid: uid, semid: semid },
        success: function (data) {
            $("#txt_percentage").val(data.percentage.toFixed(2) + "%");
        }
    });
});


/* Load Assignment & Exam Marks */
$("#sel_subject").change(function () {

    let subjectid = $(this).val();
    let uid = $("#txt_id").val();

    if (!subjectid) {
        $("#txt_first_exam_mark").val("");
        $("#txt_second_exam_mark").val("");
        $("#txt_assignment_mark").val("");
        return;
    }

    // Assignment mark
    $.ajax({
        url: "{% url 'Staff:AjaxAssignmentMark' %}",
        data: { subjectid: subjectid, uid: uid },
        success: function (data) {
            $("#txt_assignment_mark").val(data.mark);
        }
    });

    // Exam marks
    $.ajax({
        url: "{% url 'Staff:AjaxExamMark' %}",
        data: { subjectid: subjectid, uid: uid },
        success: function (data) {
            $("#txt_first_exam_mark").val(data.first);
            $("#txt_second_exam_mark").val(data.second);
        }
    });
});
</script>

{% if msg %}
<script>
alert("{{ msg }}");
window.location = "{% url 'Staff:InternalMark' uid %}";
</script>
{% endif %}

</body>
</html>
